# 计算机网络

## 概述

## 体系结构
### OSI
应用层、表示层、会话层、传输层、网络层、链路层、物理层
### 五层协议
应用层、传输层、网络层、链路层、物理层
### TCP/IP
应用层、传输层、网络层、网络接口层


### 1.物理层
单工通信、半双工通信、全双工通信

物理层包括：
集线器

### 2.链路层
封装成帧、透明传输（首部尾部，有歧义进行转义）、差错检测（CRC循环冗余检验）

链路层包括：
MAC地址、局域网（广播信道）、以太网、交换机、

信道分类：
* 广播信道
* 点对点信道

复用技术：
* 频分
* 时分
* 统计时分
* 波分（光的频分）
* 码分（码片内积得出所需结果，但是数据量变大）

### 网络层
IP数据包

NAT：一个ip加不同端口映射多台主机

网络层包括：
路由器

### 传输层
TCP的三次握手  

1. 客户机序列号、SYN

2. SYN、ACK、ack客户机序列号+1、seq服务器序列号

3. ACK、seq客户机序列号+1、ack服务器序列号+1  


首先是客户端向服务端发送连接请求，服务端接到连接请求后，返回确认信息，并建立连接。客户端收到确认信息后向服务端发送二次确认的信息，并建立连接。简单来说，三次握手使得服务端和客户端都经历了接收、发送、接收对方的确认消息这几个步骤，两个主机都对自己和对方的收发能力进行了确认，才最终建立连接。tcp机制中的重传和过期重复消息的丢弃，保证了连接的建立，且不会重复建立连接。

TCP的四次挥手
1. FIN、seq客户机序列号
2. ACK、seq服务器序列号、ack客户机序列号+1
3. 等待传输结束
4. FIN、seq服务器新序列号、ACK、ack客户机序列号+1
5. ACK、seq客户机序列号+1、ack服务器新序列号+1
6. 服务器直接关闭，客户机等两个报文最大存活时间后再关闭  

四次挥手保证了服务器可以将未发送的报文发送完毕，设置等待时间也保证了客户机可以接到最后的信息



**TCP可靠传输**：
超时重传

**TCP滑动窗口**：是一种缓存机制，让收发两端都可以进行流量控制和可靠传输  

**TCP流量控制**：（滑动窗口）

1. 通信双方主机上都分别有一个“发送窗口”和一个“接受窗口”

2. TCP连接阶段，双方协商窗口尺寸
3. 发送方根据协商的结果，发送符合窗口尺寸的数据字节流，并等待对方的确认，等待确认机制
4. 发送方根据确认信息，改变窗口的尺寸

**TCP拥塞控制**：整个网络的“流量控制”，出现拥塞时，控制发送方的发送速率

* 慢开始和拥塞避免  
  拥塞窗口cwnd，初始1，然后2、4、8，一旦达到ssthresh后，每次加1，一旦出现了超时情况，上限设为拥塞窗口目前的一半，窗口设为1，重新开始慢开始流程。
* 快重传和快恢复  
  接收方反馈每一个有序报文的最终报文，一旦某个报文丢失，前一个报文会重复反馈，3次以上，立即重发丢失报文。这时执行快恢复，上限和拥塞窗口都设为拥塞窗口目前的一半，此时仍然是拥塞避免状态，拥塞窗口每次加1。
* 当网络中出现超时状态时，则进行慢开始，如果只是丢失某个包，则在快重传之后进行快恢复。


拥塞窗口和滑动窗口是两个东西，滑动窗口是根据接收方的接受能力控制发送流量。拥塞窗口是考虑整个网络中的拥塞情况，进行控制。

#### TCP和UDP的区别
UDP是无连接的，尽可能交付，没有拥塞控制  
TCP是有连接的，靠超时重传实现可靠传输，流量控制，拥塞控制，面向字节流的。

微信传输应该是用的tcp（猜测）


### 应用层
DNS域名解析

邮件：  
发送使用SMTP，只能发送ASCII码。互联网邮件扩充MIME增加了二进制文件的编码规则，也可以通过SMTP发送。  
读取使用POP3，读取后从服务器删除，也会用IMAP服务器邮件不删除。

##### WEB页面请求过程：

1. DNS解析url成ip
4. HTTP通过网页的ip地址，先三次握手，生成TCP套接字，发送Get报文，服务器回复响应报文。浏览器接到后解析报文渲染页面。

##### DNS过程：

1. 先检查本地是否存在缓存（浏览器缓存、hosts文件）。
2. ~~DHCP配置信息，封装IP地址，通过UDP报文段，在链路广播（不需要，如果已经配置网关）。网络层ARP解析网络帧中的MAC地址，路由器根据mac转发以太网帧到网关。~~
3. 在网络上寻找DNS服务器（本地LDNS服务器->根DNS服务器和域名服务器）。
4. DNS服务器在数据库中查询域名的ip地址，封装返回。

### 各层协议
|层|协议|
|---|---|
|链路层|CSMA/CD、PPP、（ARP在OSI中是链路层协议）|
|网络层|IP(ARP地址解析协议即ip和mac的映射、ICMP网际报文控制协议(ping、traceroute)、IGMP)|
|传输层|UDP、TCP|


|应用|应用层协议|端口号|传输层|
|---|---|---|---|
|域名解析|DNS|53|UDP/TCP<br />(TCP：响应报文超过512字节；DNS服务器之间同步)|
|动态主机配置协议|DHCP|67/68|UDP|
|简单网络管理协议|SNMP|161/162|UDP|
|文件传送协议|FTP|20/21|TCP|
|远程终端协议|telnet|23|TCP|
|超文本传输协议|HTTP|23|TCP|
|简单邮件传送协议|SMTP|25|TCP|
|邮件读取协议|POP3|110|TCP|
|网际报文存取协议|IMAP|143|TCP|



## 补充内容（需要整理到各个章节）

1. 互联网基本服务：
   * WWW
   * E-mail
   * BBS
   * FTP
   * Telnet
2. 以太网数据编码格式为：曼彻斯特编码  
编码规则为：位中间电平从高到低跳变表示"0"（即下降沿），位中间电平从低到高跳变表示"1"（即上升沿）。或者位中间电平从高到低跳变表示"1"，位中间电平从低到高跳变表示"0"。
