# Zookeeper

## 一、zookeeper简介

配置管理，名字发现服务，提供分布式同步以及集群管理leader选举

### 1.1 配置管理

使用**一致性协议Zab**进行配置管理，保证了各个服务依赖的配置可以**同步配置**。

程序分布式的部署在不同的机器上，将程序的配置信息放在zk的znode下，当有配置发生改变时，也就是znode发生变化时，可以通过改变zk中某个目录节点的内容，利用watcher通知给各个客户端，从而更改配置。

现在有很多开源项目使用Zookeeper来维护配置，比如在HBase中，客户端就是连接一个Zookeeper，获得必要的HBase集群的配置信息，然后才可以进一步操作。还有在开源的消息队列Kafka中，也使用Zookeeper来维护broker的信息。在Alibaba开源的SOA框架Dubbo中也广泛的使用Zookeeper管理一些配置来实现服务治理。

### 1.2 命名服务

命名服务是指通过指定的名字来获取资源或者服务的地址，利用zk创建一个全局的路径，即是唯一的路径，这个路径就可以作为一个名字，指向集群中的机器、提供的服务的地址、或者一个远程的对象等等。

### 1.3 分布式锁

有了zookeeper的一致性文件系统，锁的问题变得容易。锁服务可以分为两类，一个是保持独占，另一个是控制时序。 

对于第一类，我们将zookeeper上的一个znode看作是一把锁，通过createznode的方式来实现。所有客户端都去创建 /distribute_lock 节点，最终成功创建的那个客户端也即拥有了这把锁。用完删除掉自己创建的distribute_lock 节点就释放出锁。 

对于第二类， /distribute_lock 已经预先存在，所有客户端在它下面创建临时顺序编号目录节点，和选master一样，编号最小的获得锁，用完删除，依次方便。

### 1.4 集群管理

所谓集群管理无在乎两点**：是否有机器退出和加入、选举master**。 

对于第一点，所有机器约定在父目录下创建临时目录节点，然后监听父目录节点的子节点变化消息。一旦有机器挂掉，该机器与 zookeeper的连接断开，其所创建的临时目录节点被删除，所有其他机器都收到通知：某个兄弟目录被删除，于是，所有人都知道：它上船了。

新机器加入也是类似，所有机器收到通知：新兄弟目录加入，highcount又有了，

对于第二点，我们稍微改变一下，所有机器创建临时顺序编号目录节点，每次选取编号最小的机器作为master就好。



## 二、Zookeeper实现

Zookeeper = 文件系统+通知机制

### 2.1 文件系统

ZooKeeper数据模型的结构与Unix文件系统很类似，整体上可以看作是**一棵树**，每个节点称做一个ZNode。

很显然zookeeper集群自身维护了一套数据结构。这个存储结构是一个树形结构，其上的每一个节点，我们称之为"znode"，每一个znode默认能够存储1MB的数据，每个ZNode都可以通过其路径唯一标识。

**四种类型的znode**

1. PERSISTENT-持久化目录节点 

	客户端与zookeeper断开连接后，该节点依旧存在 

2. PERSISTENT_SEQUENTIAL-持久化顺序编号目录节点

	客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号 

3. EPHEMERAL-临时目录节点

	客户端与zookeeper断开连接后，该节点被删除 

4. EPHEMERAL_SEQUENTIAL-临时顺序编号目录节点

	客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号

### 2.2 通知机制

client端会对某个znode建立一个watcher事件，当该znode发生变化时，这些client会收到zk的通知，然后client可以根据znode变化来做出业务上的改变等。

### 2.3 Zk集群

**四种leader选举：**



## 三、作为Dubbo注册中心

### 3.1 简介

zookeeper可以充当一个服务注册表（Service Registry），让多个服务提供者形成一个集群，让服务消费者通过服务注册表获取具体的服务访问地址（ip+端口）去访问具体的服务提供者。

### 3.2 一些问题

#### zk宕机

宕机后dubbo依然可以提供服务，只能进行服务调用，不能注册服务。dubbo消费者本地会缓存一份服务提供者列表，在zk宕机的情况下，dubbo消费者依然可以在本地缓存中得到服务提供者列表进行通讯。